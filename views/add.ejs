<%- include('partials/header.ejs'); -%>

<section>
  <h1>âž• Add New Movie</h1>

  <% if (errorMessage) { %>
    <div id="error-message">
      <i class="fas fa-exclamation-circle"></i>
      <span><%= errorMessage %></span>
    </div>
  <% } %>

  <form action="/add" method="post">
    <div class="form-group">
      <label for="newItem">Movie Title *</label>
      <div class="search-input-wrapper">
        <input
          type="text"
          id="newItem"
          name="newItem"
          value="<%= formData.title || '' %>"
          placeholder="Search for a movie..."
          required
          autocomplete="off"
        />
        <div id="search-dropdown" class="search-dropdown"></div>
      </div>
      <small class="form-hint">Search and select a movie to auto-fill details</small>
    </div>

    <div class="form-group">
      <label for="director">Director *</label>
      <input
        type="text"
        id="director"
        name="director"
        value="<%= formData.director || '' %>"
        placeholder="Director name"
        required
      />
    </div>

    <div class="form-group">
      <label for="rating">Rating (1-10) *</label>
      <input
        type="number"
        id="rating"
        name="rating"
        value="<%= formData.rating || 5 %>"
        min="1"
        max="10"
        step="0.1"
        placeholder="e.g., 8.5"
        required
      />
    </div>

    <div class="form-group">
      <label for="description">Description *</label>
      <textarea
        id="description"
        name="description"
        placeholder="Movie description/plot..."
        required
      ><%= formData.description || '' %></textarea>
    </div>

    <div class="form-group">
      <label for="userComment">Your Comment (Optional)</label>
      <textarea
        id="userComment"
        name="userComment"
        placeholder="Add your personal comment about this movie..."
      ><%= formData.userComment || '' %></textarea>
    </div>

    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <a href="/" class="btn btn-secondary">
        <i class="fas fa-times"></i>
        Cancel
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add Movie
      </button>
    </div>
  </form>
</section>

<script>
  const titleInput = document.getElementById('newItem');
  const directorInput = document.getElementById('director');
  const descriptionInput = document.getElementById('description');
  const searchDropdown = document.getElementById('search-dropdown');
  let searchTimeout;

  // Show search dropdown when user types
  titleInput.addEventListener('input', function() {
    const query = titleInput.value.trim();
    
    if (query.length < 2) {
      searchDropdown.innerHTML = '';
      searchDropdown.style.display = 'none';
      return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        if (Array.isArray(results) && results.length > 0) {
          // Show only top 5 results
          const topResults = results.slice(0, 5);
          renderSearchDropdown(topResults);
        } else {
          searchDropdown.innerHTML = '<div class="search-no-results">No movies found</div>';
          searchDropdown.style.display = 'block';
        }
      } catch (error) {
        // Silently handle search error
        searchDropdown.innerHTML = '<div class="search-no-results">Error searching</div>';
        searchDropdown.style.display = 'block';
      }
    }, 500);
  });

  // Render search results as dropdown items
  function renderSearchDropdown(results) {
    searchDropdown.innerHTML = results.map(movie => `
      <div class="search-result" onclick="selectMovie('${movie.title.replace(/'/g, "\\'")}')">
        <img src="${movie.poster ? movie.poster : 'https://via.placeholder.com/40x60?text=No+Image'}" alt="${movie.title}" class="result-poster" />
        <div class="result-info">
          <div class="result-title">${movie.title}</div>
          <div class="result-year">${movie.year}</div>
        </div>
      </div>
    `).join('');
    searchDropdown.style.display = 'block';
  }

  // Select a movie from dropdown and fetch details
  async function selectMovie(title) {
    titleInput.value = title;
    searchDropdown.innerHTML = '';
    searchDropdown.style.display = 'none';

    try {
      const response = await fetch(`/api/movie-details?title=${encodeURIComponent(title)}`);
      if (!response.ok) {
        return;
      }
      const data = await response.json();
      
      if (data.success && data.data) {
        directorInput.value = data.data.director || '';
        descriptionInput.value = data.data.plot || '';
      }
    } catch (error) {
      // Silently handle fetch error
    }
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.search-input-wrapper')) {
      searchDropdown.innerHTML = '';
      searchDropdown.style.display = 'none';
    }
  });
</script>

<%- include('partials/footer.ejs'); -%>
